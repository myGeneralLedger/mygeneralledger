<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>General Ledger with Cash Ledger</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    table, th, td {
      border: 1px solid #aaa;
      border-collapse: collapse;
      padding: 6px;
    }
    table { width: 100%; margin-top: 10px; }
    th { background-color: #f0f0f0; }
    input, select, button { margin: 5px; padding: 6px; }
    .section { margin-bottom: 40px; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h1>General Ledger</h1>

  <!-- Navigation -->
  <div class="section">
    <button onclick="showTab('ledgerTab')">Ledger</button>
    <button onclick="showTab('cashTab')">Cash Ledger</button>
  </div>

  <!-- Ledger Tab -->
  <div id="ledgerTab" class="section">
    <!-- Existing content here (add accounts, journal entries, balance sheet, etc.) -->
    <h2>Ledger Functionality Goes Here...</h2>
    <!-- You would paste all your current general ledger code in here -->
  </div>

  <!-- Cash Ledger Tab -->
  <div id="cashTab" class="section hidden">
    <h2>Cash Ledger</h2>
    <select id="cashMonthSelect">
      <option value="">-- Select Month --</option>
    </select>
    <div id="cashLedgerContainer"></div>
  </div>

<script>
(() => {
  let journalEntries = JSON.parse(localStorage.getItem("ledger_journal")) || [];
  let balances = JSON.parse(localStorage.getItem("ledger_balances")) || {};

  function pad(n) { return n < 10 ? "0" + n : n; }
  function getMonthKey(dateStr) {
    const d = new Date(dateStr);
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}`;
  }

  function showTab(tabId) {
    document.querySelectorAll('.section').forEach(div => div.classList.add("hidden"));
    document.getElementById(tabId).classList.remove("hidden");
  }

  function groupCashTransactionsByMonth() {
    const months = {};
    let cashBalance = 0;
    const sorted = [...journalEntries].sort((a, b) => new Date(a.date) - new Date(b.date));

    sorted.forEach(entry => {
      const mKey = getMonthKey(entry.date);
      if (!months[mKey]) months[mKey] = { entries: [], begin: cashBalance };

      let affected = false;
      if (entry.debit.account === "Cash") {
        cashBalance += entry.debit.amount;
        months[mKey].entries.push({
          date: entry.date,
          desc: entry.description,
          type: "Debit",
          amount: entry.debit.amount,
          balance: cashBalance
        });
        affected = true;
      }

      if (entry.credit.account === "Cash") {
        cashBalance -= entry.credit.amount;
        months[mKey].entries.push({
          date: entry.date,
          desc: entry.description,
          type: "Credit",
          amount: entry.credit.amount,
          balance: cashBalance
        });
        affected = true;
      }

      if (affected) {
        months[mKey].end = cashBalance;
      }
    });

    return months;
  }

  function populateMonthDropdown(months) {
    const select = document.getElementById("cashMonthSelect");
    select.innerHTML = '<option value="">-- Select Month --</option>';
    Object.keys(months).sort().forEach(m => {
      select.add(new Option(m, m));
    });
  }

  function renderCashLedger(monthKey, data) {
    const container = document.getElementById("cashLedgerContainer");
    if (!data || !data[monthKey]) {
      container.innerHTML = "<p>No cash activity for this month.</p>";
      return;
    }

    const { entries, begin, end } = data[monthKey];
    let html = `<p><strong>Beginning Balance:</strong> ${begin.toFixed(2)}</p>`;
    html += `<table>
      <thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Running Balance</th></tr></thead>
      <tbody>`;

    entries.forEach(e => {
      html += `<tr>
        <td>${e.date}</td>
        <td>${e.desc}</td>
        <td>${e.type}</td>
        <td>${e.amount.toFixed(2)}</td>
        <td>${e.balance.toFixed(2)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    html += `<p><strong>Ending Balance:</strong> ${end.toFixed(2)}</p>`;

    container.innerHTML = html;
  }

  document.getElementById("cashMonthSelect").addEventListener("change", e => {
    const monthKey = e.target.value;
    const grouped = groupCashTransactionsByMonth();
    renderCashLedger(monthKey, grouped);
  });

  function init() {
    const grouped = groupCashTransactionsByMonth();
    populateMonthDropdown(grouped);
  }

  init();
})();
</script>

</body>
</html>
